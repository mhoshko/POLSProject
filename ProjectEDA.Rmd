---
title: "ProjectEDA"
author: "Madeline Hoshko"
date: "4/19/2020"
output: html_document
---
```{r set-options, echo=FALSE, cache=FALSE}
options(width = 10000)
```
<style type="text/css">
.main-container {
  max-width: 1800px;
  margin-left: auto;
  margin-right: auto;
}
</style>
```{r, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning=FALSE, message=FALSE)
library(tidyverse)
library(tidytext)
library(textdata)
library(wordcloud)
library(dplyr)
library(rtweet)
library(stringr)
library(scales)
library(lubridate)
library(datetime)
```


# Data import, cleaning, and exploration 
```{r}
cf <- readRDS("data/campfire-tweets-2020-04-17.Rds")

Sources <- cf %>%
  filter(str_detect(screen_name, "CALFIRE_ButteCo|Cal_Fire|ButteSheriff|ChicoPolice|ChicoFD|CountyOfButte|Paradise_CA PGE4Me"))


no_outliers <- top_n(Sources, -28, created_at_pst)

no_outliers %>%
  group_by(screen_name) %>%
  summarize(min(created_at_pst))



no_outliers$screen_name <- as.factor(no_outliers$screen_name)

no_outliers %>% group_by(tweet_hour, screen_name, tweet_min) %>% 
       summarize(tweet_count=n()) %>% 
    ggplot(aes(x=tweet_hour, y=tweet_count, fill=screen_name)) + geom_col()


range(Sources$created_at_pst)


plot.fav  <- no_outliers %>% filter(favorite_count>1) %>% ggplot(aes(x=favorite_count, fill=screen_name)) + geom_histogram()
plot.rt  <- no_outliers %>% filter(retweet_count>1) %>% ggplot(aes(x=retweet_count, fill=screen_name)) + geom_histogram()
plot.quo  <- no_outliers %>% filter(quote_count>1) %>% ggplot(aes(x=quote_count, fill=screen_name)) + geom_histogram()
plot.rply  <- no_outliers %>% filter(reply_count>1) %>% ggplot(aes(x=reply_count, fill=screen_name)) + geom_histogram()

gridExtra::grid.arrange(plot.fav, plot.rt, plot.quo, plot.rply, nrow=2)
```


```{r include=FALSE}

# name_levels <- c("CALFIRE_ButteCo", "ButteSheriff", "ChicoFD")
# status_colors <- c("#0070C0", "#00B050", "#FFC000")
# no_outliers$screen_name <- factor(no_outliers$screen_name, levels=name_levels, ordered=TRUE)
# 
# positions <- c(-2, -0.5, -1.0, 2, -1.5, 1.5, 1, .5, 2.5, -2.5, 3, -3, 3.5, -3.5, 4, -4)
# directions <- c(1, -1)
# 
# line_pos <- data.frame(
#     "created_at_pst"=unique(no_outliers$created_at_pst),
#     "position"=rep(positions, length.out=length(unique(no_outliers$created_at_pst))),
#     "direction"=rep(directions, length.out=length(unique(no_outliers$created_at_pst)))
# )
# 
# 
# no_outliers <- merge(x=no_outliers, y=line_pos, by="created_at_pst", all = TRUE)
# no_outliers <- no_outliers[with(no_outliers, order(created_at_pst, screen_name)), ]
# 
# 
# 
# hour_buffer <- 2
# date_range <- seq(min(no_outliers$created_at_pst) - hours(hour_buffer),
#                   max(no_outliers$created_at_pst) + hours(hour_buffer), by='hour')
# 
# 
# date_format <- format(date_range, '%H:%M')
# date_df <- data.frame(date_range, date_format)
# 
# 
# text_offset <- 0.05
# no_outliers$text_position <- (text_offset * no_outliers$direction) +
#   no_outliers$position
# 
# no_outliers$text_output <- substr(no_outliers$text, 1, 20)
# ```
# 
# ```{r}
# timeline_plot<-ggplot(no_outliers,aes(x=created_at_pst,y=0, col=screen_name,
#                                       label=text_output)) + labs(col="Tweets")
#   
#   
# #timeline_plot<-timeline_plot+labs(col="Tweets")
# timeline_plot<-timeline_plot+scale_color_manual(values=status_colors,
#                                                 labels=name_levels, drop = FALSE)
# 
# timeline_plot<-timeline_plot+theme_classic()
# 
# # Plot horizontal black line for timeline
# timeline_plot<-timeline_plot+geom_hline(yintercept=0, 
#                 color = "black", size=0.3)
# 
# # Plot vertical segment lines for texts
# timeline_plot<-timeline_plot+geom_segment(data=no_outliers,
#                                           aes(y=position,yend=0,xend=created_at_pst),
#                                           color='black', size=0.2)
# 
# # Plot scatter points at zero and date
# timeline_plot<-timeline_plot+geom_point(aes(y=0), size=3)
# 
# # Don't show axes, appropriately position legend
# timeline_plot<-timeline_plot+theme(axis.line.y=element_blank(),
#                  axis.text.y=element_blank(),
#                  axis.title.x=element_blank(),
#                  axis.title.y=element_blank(),
#                  axis.ticks.y=element_blank(),
#                  axis.text.x =element_blank(),
#                  axis.ticks.x =element_blank(),
#                  axis.line.x =element_blank(),
#                  legend.position = "bottom"
#                 )
# 
# # Show text for each hour
# timeline_plot<-timeline_plot+geom_text(data=date_df,
#                                 aes(x=date_range,y=-0.1, label=date_format),
#                                 size=2.5,vjust=0.5, color='black', angle=45)
# 
# # Show text for each text
# timeline_plot<-timeline_plot+geom_text(aes(y=text_position,label=text_output),size=2.5)  
# 
# 
# print(timeline_plot)
```


# Timeline Creation
```{r}
library(vistime)
library(plotly)
no_outliers$text <- gsub("(\\. )", "\\.\n", no_outliers$text)
no_outliers$text <- gsub("(^\\#)", "\n\\#", no_outliers$text)
no_outliers$text <- gsub("(^\\@)", "\n\\@", no_outliers$text)
no_outliers$text <- gsub("(\\: )+", "\\:\n", no_outliers$text)
no_outliers$text <- gsub("(http)", "\nhttp", no_outliers$text)


created_at_pst <- as.POSIXct(c("2018-11-08 6:29:00", "2018-11-08 6:33:00", "2018-11-08 6:44:00", 
                 "2018-11-08 6:51:00", "2018-11-08 7:00:00", "2018-11-08 7:17:00", 
                 "2018-11-08 7:23:00", "2018-11-08 7:46:00", "2018-11-08 7:59:00", 
                 "2018-11-08 8:03:00", "2018-11-08 8:07:00", "2018-11-08 8:15:00",
                 "2018-11-08 10:45:00"))

text <- c("Camp Fire Starts", "PG&E field crew reports fire under power transmission lines near Poe Dam to Cal Fire", "Captain Matt McKenzie radios for resources and evacuations", "Fire reaches 10 acres", "Fire enters Concow", "Cal Fire begins sending in firefighters", "Evacuation Order given for entire town of Pulga", "A state fire captain calls for an evacuation order for the eastern side of Paradise", "Fire enters Paradise", "Evacuation Order given to the eastern half of Paradise, including all of Pentz Road", "A fallen tree blocks Hoffman Road, Concow main escape route, trapping a state fire crew and 20 residents. Eight die as the fire passes over them.", "Flames are reported at Feather River Hospital. Staff begins to evacuate patients.", "NASA photo shows 20,000 acres burned")


day_events <- data.frame(text, created_at_pst)
day_events$screen_name <- "Events in Real Time"
timeline_data <- no_outliers[,c("text", "created_at_pst", "screen_name")]
timeline_data <- rbind(timeline_data, day_events)

time <- (vistime(timeline_data, events = "text", start = "created_at_pst", groups="screen_name", show_labels=FALSE, color = "#0bc8e0", title="Timeline of Events"))

day_timeline <- plotly_build(time)

m <- list(
    l = 50,
    r = 50,
    b = 100,
    t = 100,
    pad = 4
)

plot <- day_timeline %>%
layout(autosize = F, width = 1100, height = 600, margin = m)
plot
```









```{r}
news <- cf %>%
  filter(str_detect(screen_name,"news|News") | str_detect(description, "news|News")) %>%
  filter(verified=="TRUE")

news_orgs <- cf %>%
  users_data() %>%
  distinct(screen_name, .keep_all = TRUE) %>%
  filter(str_detect(screen_name, "news|News") | str_detect(description, "news|News")) %>%
  filter(verified=="TRUE") %>%
  arrange(desc(followers_count)) 

news$user_type <- "news"
public <- anti_join(x = cf, y = news_orgs, by = "screen_name")
public$user_type <- "public"

cf <- rbind(public, news)


top.20.users <- news %>% 
  group_by(screen_name) %>% 
  summarise(n=n()) %>% 
  arrange(desc(n)) %>% 
  slice(1:20)

ggplot(top.20.users, aes(x = reorder(screen_name, -n), y=n)) +
  geom_bar(stat="identity", fill="darkslategray")+
  theme_minimal() + coord_flip() + 
  xlab("Users") + ylab("Count")
```


```{r, include=FALSE}
tweet <- tibble(status_id=Sources$status_id, text=Sources$text)
remove_reg <- "&amp;|&lt;|&gt;"
tweet_words <- tweet %>% 
                  mutate(text = str_remove_all(text, remove_reg)) %>%
                  unnest_tokens(word, text, token="tweets")
tweet_words %>% print(n=15)
data("stop_words")
head(stop_words)

tweet_words_nostop <- tweet_words %>% anti_join(stop_words)
head(tweet_words_nostop)

tweet_words_nostop %>% count(word, sort = TRUE)

tweet_words_nostop %>%
  count(word, sort = TRUE) %>%
  filter(n > 2000) %>%
  mutate(word = reorder(word, n)) %>%
  ggplot(aes(word, n)) +
  geom_col() +
  xlab(NULL) +
  coord_flip()

#need to implement proportions graph
```



# Applying Sentiments
I'm interested in the sentiment difference between users who are considered a news outlet vs the general public. We plan to look at more individual political people like the Sheriff when going through this more thoroughly in our project. 

```{r}
ts1 <- tweet_words_nostop %>%
          inner_join(get_sentiments("afinn"))

ts2 <- ts1 %>% group_by(status_id) %>% summarize(sentiment=sum(value))
cf2 <- Sources %>% left_join(ts2, by='status_id')

ggplot(cf2, aes(x=sentiment, col=screen_name)) + geom_density(lwd=2) + theme_minimal()
```


